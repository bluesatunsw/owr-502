# Stepper Driver

A device to drive up to four high-current (10A peak, 5A continuous) bipolar stepper motors or eight brushed DC motors/solenoids. External sensors/low power devices may also be attached. It complies with the common device specification 2025-04.

## Steppers

Each stepper motor channel is driven by a TMC5160 controller. These controllers operate by driving two external full bridges, allowing for significantly more current to be delivered compared to devices with internal MOSFETs (such as the TMC2160).

Communication between the MCU and stepper controllers is performed using SPI. To allow for precise velocity control, the MCU provides a clock signal (using the MCO pin) to the clock input of the stepper drivers. Weak parallel termination (470R) is applied to reduce overshoot. The VSA rail of each controller is fed from the device 12V rail to reduce the heat generated by the internal linear regulators. For safety, the `DRV_ENN` pin of each stepper should be tied to a common line controlled by the MCU, externally pulled high.

The coils of the stepper motors are connected using a 4-pin JST-VH connector. A 6-pin JST-PA connector exposes the reference switch and A/B encoder pins of the controller, along with 3V3 and GND.

The TMC5160 datasheet states that 100u of capacitance per amp of output current is required; however, this requirement can be reduced significantly by using polymer capacitors, which have a very low ESR. A 220u capacitor (HV1H227M1010PZ) per channel should be sufficient.

### Coil Pinout

| Pin | Signal | Colour |
| --- | ------ | ------ |
|  1  | `-A`   | Black  |
|  2  | `+A`   | Red    |
|  3  | `-B`   | Brown  |
|  4  | `+B`   | White  |

### Sensor Pinout

| Pin | Signal | Colour |
| --- | ------ | ------ |
|  1  | `GND`  | Black  |
|  2  | `VDD`  | Red    |
|  3  | `REFL` | Yellow |
|  4  | `REFR` | Green  |
|  5  | `ENCA` | Blue   |
|  6  | `ENCB` | Purple |

## Breakout Port

External sensors and low-power devices may be connected via a 24-pin JST-ZPD breakout header exposing:
- power from the VDD, 12V and bus rails;
- digital communication via I2C, SPI and UART/USART;
- digital GPIO including timer channels; and
- analog GPIO including op-amp and comparator channels.

The IO pins routed to the breakout port are not otherwise used for any other purpose.

**[TODO] Specify pinout**

## Internal Sensors

- Each stepper channel has an NTC thermistor (NCP15XH103F03RC) for temperature monitoring.
- A 6-axis IMU (ASM330LHH) and 3-axis magnetometer (LIS2MDL), both communicating over I2C, may optionally be installed to allow for groundstation use and advanced control modes.
